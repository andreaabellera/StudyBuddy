name: Backend Unit & Regression Test

on:
  workflow_dispatch:   # Allows this workflow to be ran manually from the Actions tab
  push:
    branches: [ backend ]
  pull_request:
    branches: [ main ] # Run regression tests upon PR to main
    # No integration tests as of Sprint 2, so only unit tests will be ran

jobs:
  run_unit_tests:
    runs-on: ubuntu-latest
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: admin
          ACCEPT_EULA: 'Y'
        ports:
          - 1433:1433

    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Push Code onto VM
        uses: actions/checkout@v3.3.0

      - name: Setup Python Environment
        uses: actions/setup-python@v4.5.0
        with:
          python-version: '3.11.1'

      - name: Install Packages and Dependencies
        run:
          pip install -r requirements.txt

      #- name: Install a SQL Server suite of tools
      #  uses: potatoqualitee/mssqlsuite@v1.7
      #  with:
      #    install: sqlengine, sqlclient, sqlpackage, localdb
      #    version: 2022

      #- name: Download and start the MSSQL container
      #  run:
      #    docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=dbtools.IO" -p 1433:1433 -d mcr.microsoft.com/mssql/server:2022-latest

      - name: Compile and Test from Build Script
        shell: pwsh
        run: .\build.ps1 ci-pr $
        env:
          ConnectionStrings__MyConnString: "Server=localhost,1433;Initial Catalog=StudyBuddy.bak;User Id=sa;Password=admin;"

      - name: Connect to SQL Server
        run:
          sqlcmd -S localhost -U sa -P dbatools.IO -d StudyBuddy.bak -Q "SELECT @@version;"

      - name: Run Unit Tests
        run:
          python -m unittest discover -p "*_test.py"
